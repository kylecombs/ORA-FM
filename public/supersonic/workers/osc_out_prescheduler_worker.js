(()=>{function j(e,t,r){return(r-1-e+t)%r}function ee({uint8View:e,dataView:t,bufferStart:r,bufferSize:s,head:n,payload:c,sequence:i,messageMagic:a,headerSize:f,sourceId:_=0,headerScratch:Y=null,headerScratchView:M=null}){let m=c.length,I=f+m+3&-4,U=s-n;if(I>U){let u=Y||new Uint8Array(f),C=M||new DataView(u.buffer);C.setUint32(0,a,!0),C.setUint32(4,I,!0),C.setUint32(8,i,!0),C.setUint32(12,_,!0);let b=r+n,w=r;if(U>=f){e.set(u,b);let L=U-f;L>0&&e.set(c.subarray(0,L),b+f),e.set(c.subarray(L),w)}else{e.set(u.subarray(0,U),b),e.set(u.subarray(U),w);let L=f-U;e.set(c,w+L)}}else{let u=r+n;t.setUint32(u,a,!0),t.setUint32(u+4,I,!0),t.setUint32(u+8,i,!0),t.setUint32(u+12,_,!0),e.set(c,u+f)}return(n+I)%s}function Ie(e,t,r=0,s=!1){for(let n=0;n<=r;n++)if(Atomics.compareExchange(e,t,0,1)===0)return!0;if(s){for(let c=0;c<100;c++)if(Atomics.wait(e,t,1,100),Atomics.compareExchange(e,t,0,1)===0)return!0;return console.error("[RingBuffer] Lock acquisition timeout after 10s - possible deadlock"),!1}return!1}function Ce(e,t){Atomics.store(e,t,0),Atomics.notify(e,t,1)}function te({atomicView:e,dataView:t,uint8View:r,bufferConstants:s,ringBufferBase:n,controlIndices:c,oscMessage:i,sourceId:a=0,maxSpins:f=0,useWait:_=!1}){let Y=i.length,M=s.MESSAGE_HEADER_SIZE+Y;if(M>s.IN_BUFFER_SIZE-s.MESSAGE_HEADER_SIZE||!Ie(e,c.IN_WRITE_LOCK,f,_))return!1;try{let m=Atomics.load(e,c.IN_HEAD),J=Atomics.load(e,c.IN_TAIL),I=M+3&-4;if(j(m,J,s.IN_BUFFER_SIZE)<I)return!1;let u=Atomics.add(e,c.IN_SEQUENCE,1),C=ee({uint8View:r,dataView:t,bufferStart:n+s.IN_BUFFER_START,bufferSize:s.IN_BUFFER_SIZE,head:m,payload:i,sequence:u,messageMagic:s.MESSAGE_MAGIC,headerSize:s.MESSAGE_HEADER_SIZE,sourceId:a});return Atomics.load(e,c.IN_HEAD),Atomics.store(e,c.IN_HEAD,C),Atomics.notify(e,c.IN_HEAD,1),!0}finally{Ce(e,c.IN_WRITE_LOCK)}}function se(e,t){let r=e+t;return{IN_HEAD:(r+0)/4,IN_TAIL:(r+4)/4,IN_SEQUENCE:(r+24)/4,IN_WRITE_LOCK:(r+40)/4,IN_LOG_TAIL:(r+44)/4}}var A="sab",v=null,K=1024,Oe=65536,ce=3600,Se=4294967295,D=null,H=null,T=null,P=null,ue=null,Te=null,B={},E=null,F=null,Ee=null,W=150,g=(e,t)=>{E&&(A==="sab"?Atomics.store(E,e,t):E[e]=t)},fe=e=>E?A==="sab"?Atomics.load(E,e):E[e]:0,p=(e,t)=>{E&&(A==="sab"?Atomics.add(E,e,t):E[e]+=t)},y=(e,t)=>{E&&(A==="sab"?Atomics.store(E,e,t):E[e]=t)},le=e=>E?A==="sab"?Atomics.load(E,e):E[e]:0,Me=()=>{if(A!=="postMessage"||Ee!==null)return;let e=()=>{F&&E&&self.postMessage({type:"preschedulerMetrics",metrics:new Uint32Array(F.slice(0))}),Ee=setTimeout(e,W)};e(),S("[PreScheduler] Started metrics sending (every "+W+"ms)")};var o=[],R=null,x=1/0,me=0,ie=!1,l=[],k=!1,h=65536,xe=2208988800,$=.5,S=(...e)=>{},V=()=>(performance.timeOrigin+performance.now())/1e3+xe,He=e=>{if(e.length>=16&&e[0]===35){let t=new DataView(e.buffer,e.byteOffset),r=t.getUint32(8,!1),s=t.getUint32(12,!1);return r+s/4294967296}return null},Be=()=>{if(!D||!T){console.error("[PreScheduler] Cannot init - missing buffer or constants");return}P=new Int32Array(D),ue=new DataView(D),Te=new Uint8Array(D),B=se(H,T.CONTROL_START);let e=H+T.METRICS_START;E=new Uint32Array(D,e,T.METRICS_SIZE/4),S("[PreScheduler] SharedArrayBuffer initialized with direct ring buffer writing and metrics")},G=()=>{if(!E)return;g(9,o.length);let e=o.length,t=fe(10);e>t&&g(10,e)},d=(e,t,r=0,s=!1)=>{if(A==="postMessage")return v?(v.postMessage({type:"osc",oscData:e,sourceId:r}),p(12,1),!0):(console.error("[PreScheduler] No worklet port available"),!1);if(!D||!P)return console.error("[PreScheduler] Not initialized for ring buffer writing"),!1;let n=e.length,c=T.MESSAGE_HEADER_SIZE+n;return c>T.IN_BUFFER_SIZE-T.MESSAGE_HEADER_SIZE?(console.error("[PreScheduler] Message too large:",c),!1):te({atomicView:P,dataView:ue,uint8View:Te,bufferConstants:T,ringBufferBase:H,controlIndices:B,oscMessage:e,sourceId:r,maxSpins:10,useWait:s})?(p(12,1),!0):!1},N=(e,t,r=0)=>{let s=o.length+l.length;if(s>=h){console.error("[PreScheduler] Backpressure: dropping retry ("+s+" pending)"),p(17,1);return}l.push({oscData:e,context:t||"unknown",queuedAt:performance.now(),sourceId:r}),g(18,l.length);let n=fe(19);l.length>n&&g(19,l.length),S("[PreScheduler] Queued message for retry:",t,"queue size:",l.length),Ae()},Ae=()=>{if(k||l.length===0||A!=="sab")return;k=!0;let e=Atomics.load(P,B.IN_TAIL),t=Atomics.waitAsync(P,B.IN_TAIL,e),r=()=>{k=!1,Fe(),l.length>0&&Ae()};t.async?t.value.then(r):queueMicrotask(r)},Fe=()=>{if(l.length===0)return;let e=0;for(;e<l.length;){let t=l[e];if(d(t.oscData,!0,t.sourceId,!0))l.splice(e,1),p(16,1),g(18,l.length);else break}},_e=(e,t,r,s=0)=>{let n=o.length+l.length;if(n>=h){let _=`Prescheduler queue full (${n} >= ${h} max)`;return console.error("[PreScheduler]",_),self.postMessage({type:"error",error:_,code:"PRESCHEDULER_QUEUE_FULL"}),!1}let c=He(e);if(c===null)return S("[PreScheduler] Non-bundle message, dispatching immediately"),d(e,!1,s,!0)||N(e,"immediate message",s),!0;let i=V(),a=c-i;if(e.length>K){let _=`Bundle too large for scheduler (${e.length} > ${K} bytes)`;return console.error("[PreScheduler]",_),self.postMessage({type:"error",error:_,code:"BUNDLE_TOO_LARGE"}),!1}if(a>ce){let _=`Bundle scheduled too far in future (${a.toFixed(0)}s > ${ce}s max)`;return console.error("[PreScheduler]",_),self.postMessage({type:"error",error:_,code:"BUNDLE_TOO_FAR_FUTURE"}),!1}let f={ntpTime:c,seq:me++,sessionId:t||0,runTag:r||"",oscData:e,sourceId:s};return ye(f),p(11,1),G(),S("[PreScheduler] Scheduled bundle:","NTP="+c.toFixed(3),"current="+i.toFixed(3),"wait="+(a*1e3).toFixed(1)+"ms","pending="+o.length),O(),!0},ye=e=>{o.push(e),Ye(o.length-1)},pe=()=>o.length>0?o[0]:null,Ge=()=>{if(o.length===0)return null;let e=o[0],t=o.pop();return o.length>0&&(o[0]=t,Re(0)),e},Ye=e=>{for(;e>0;){let t=Math.floor((e-1)/2);if(Z(o[e],o[t])>=0)break;Ue(e,t),e=t}},Re=e=>{let t=o.length;for(;;){let r=2*e+1,s=2*e+2,n=e;if(r<t&&Z(o[r],o[n])<0&&(n=r),s<t&&Z(o[s],o[n])<0&&(n=s),n===e)break;Ue(e,n),e=n}},Z=(e,t)=>e.ntpTime===t.ntpTime?e.seq-t.seq:e.ntpTime-t.ntpTime,Ue=(e,t)=>{let r=o[e];o[e]=o[t],o[t]=r},O=()=>{if(o.length===0){R!==null&&(clearTimeout(R),R=null,x=1/0);return}let e=pe().ntpTime-$,t=V();if(e<x){R!==null&&clearTimeout(R);let r=Math.max(0,(e-t)*1e3);x=e,R=setTimeout(we,r)}},be=()=>{R===null&&(S("[PreScheduler] Starting demand-driven dispatching"),O())};var we=()=>{ie=!0;let e=V(),t=e+$,r=0;for(;o.length>0;){let s=pe();if(s.ntpTime<=t){Ge(),G();let n=s.ntpTime-e;if(p(21,1),n<0){let i=Math.round(-n*1e3);p(15,1);let a=le(23);i>a&&y(23,i)}else{let i=Math.round(n*1e3),a=le(14);(a===Se||i<a)&&y(14,i)}S("[PreScheduler] Dispatching bundle:","NTP="+s.ntpTime.toFixed(3),"current="+e.toFixed(3),"early="+(n*1e3).toFixed(1)+"ms","remaining="+o.length),d(s.oscData,!1,s.sourceId,!0)||N(s.oscData,"scheduled bundle NTP="+s.ntpTime.toFixed(3),s.sourceId),r++}else break}(r>0||o.length>0||l.length>0)&&S("[PreScheduler] Dispatch cycle complete:","dispatched="+r,"pending="+o.length,"retrying="+l.length),ie=!1,R=null,x=1/0,O()},z=e=>{if(o.length===0)return;let t=o.length,r=[];for(let n=0;n<o.length;n++){let c=o[n];e(c)||r.push(c)}let s=t-r.length;s>0&&(o=r,ke(),p(13,s),G(),S("[PreScheduler] Cancelled "+s+" events, "+o.length+" remaining"),O())},ke=()=>{for(let e=Math.floor(o.length/2)-1;e>=0;e--)Re(e)},Qe=(e,t)=>{z(r=>r.sessionId===e&&r.runTag===t)},Xe=e=>{z(t=>t.sessionId===e)},ve=e=>{z(t=>t.runTag===e)},Ke=()=>{let e=o.length,t=l.length;e===0&&t===0||(p(13,e+t),o=[],l=[],g(18,0),G(),S("[PreScheduler] Cancelled all "+e+" events, "+t+" retries"),O())},We=e=>!e||e.length<8?!1:e[0]===35&&e[1]===98&&e[2]===117&&e[3]===110&&e[4]===100&&e[5]===108&&e[6]===101&&e[7]===0,Ze=e=>{let t=[],r=new DataView(e.buffer,e.byteOffset,e.byteLength),s=16;for(;s+4<=e.length;){let n=r.getInt32(s,!1);if(s+=4,n<=0||n>Oe||s+n>e.length)break;let c=e.slice(s,s+n);for(t.push(c),s+=n;s%4!==0&&s<e.length;)s++}return t},qe=(e,t=0)=>{if(We(e)){let r=Ze(e);for(let s=0;s<r.length;s++)d(r[s],!1,t,!0)||N(r[s],"immediate bundle message "+s,t)}else d(e,!1,t,!0)||N(e,"immediate message",t)};self.addEventListener("message",e=>{let{data:t}=e;try{switch(t.type){case"init":if(A=t.mode||"sab",t.maxPendingMessages&&(h=t.maxPendingMessages),t.snapshotIntervalMs&&(W=t.snapshotIntervalMs),t.bypassLookaheadS!==void 0&&($=t.bypassLookaheadS),A==="sab")D=t.sharedBuffer,H=t.ringBufferBase,T=t.bufferConstants,Be(),T&&T.scheduler_slot_size&&(K=T.scheduler_slot_size);else{v=t.workletPort;let s=184;F=new ArrayBuffer(s),E=new Uint32Array(F),Me()}y(14,Se),y(23,0),be(),S("[OSCPreSchedulerWorker] Initialized with NTP-based scheduling, mode="+A+", capacity="+h),self.postMessage({type:"initialized"});break;case"addOscSource":let r=e.ports[0];r&&(r.onmessage=s=>{s.data.type==="osc"&&s.data.oscData&&_e(s.data.oscData,0,"",s.data.sourceId||0)},S("[OSCPreSchedulerWorker] Added external OSC source"));break;case"send":_e(t.oscData,t.sessionId||0,t.runTag||"",t.sourceId||0);break;case"sendImmediate":qe(t.oscData,t.sourceId||0);break;case"directDispatch":d(t.oscData,!1,t.sourceId||0,!0)||N(t.oscData,"directDispatch fallback",t.sourceId||0);break;case"cancelSessionTag":t.runTag!==void 0&&t.runTag!==null&&t.runTag!==""&&Qe(t.sessionId||0,t.runTag);break;case"cancelSession":Xe(t.sessionId||0);break;case"cancelTag":t.runTag!==void 0&&t.runTag!==null&&t.runTag!==""&&ve(t.runTag);break;case"cancelAll":Ke(),t.ack&&self.postMessage({type:"cancelAllAck"});break;default:}}catch(r){console.error("[OSCPreSchedulerWorker] Error:",r),self.postMessage({type:"error",error:r.message})}});S("[OSCPreSchedulerWorker] Script loaded");})();
