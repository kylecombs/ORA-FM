(()=>{function P({uint8View:o,dataView:e,bufferStart:t,bufferSize:s,head:N,tail:R,messageMagic:a,paddingMagic:A,headerSize:p,maxMessages:i=1/0,onMessage:_,onCorruption:S}){let E=R,x=0,O=B=>{let T=B;if(T+4<=s)return e.getUint32(t+T,!0);let C=0;for(let I=0;I<4;I++)C|=o[t+(T+I)%s]<<I*8;return C};for(;E!==N&&x<i;){let B=s-E,T;if(B>=4?T=e.getUint32(t+E,!0):T=O(E),T===A){E=0;continue}if(T!==a){S&&S(E),E=(E+1)%s;continue}let C=O((E+4)%s),I=O((E+8)%s),G=O((E+12)%s);if(C<p||C>s){S&&S(E),E=(E+1)%s;continue}let d=C-p,g=t+(E+p)%s;_(g,d,I,G),E=(E+C)%s,x++}return{newTail:E,messagesRead:x}}function f(o,e){let t=o+e;return{OUT_HEAD:(t+8)/4,OUT_TAIL:(t+12)/4}}var W=2208988800,X=()=>(performance.timeOrigin+performance.now())/1e3+W,D=null,l=null,n=null,M=null,F=null,c=null,U={},r=null,L=!1,Q=(...o)=>{},H=-1,K=(o,e,t)=>{D=o,l=e,c=t,n=new Int32Array(D),M=new DataView(D),F=new Uint8Array(D),U=f(l,c.CONTROL_START);let s=l+c.METRICS_START;r=new Uint32Array(D,s,c.METRICS_SIZE/4)},k=()=>{let o=Atomics.load(n,U.OUT_HEAD),e=Atomics.load(n,U.OUT_TAIL);if(o===e)return[];let t=[],{newTail:s,messagesRead:N}=P({uint8View:F,dataView:M,bufferStart:l+c.OUT_BUFFER_START,bufferSize:c.OUT_BUFFER_SIZE,head:o,tail:e,messageMagic:c.MESSAGE_MAGIC,paddingMagic:c.PADDING_MAGIC,headerSize:c.MESSAGE_HEADER_SIZE,maxMessages:100,onMessage:(R,a,A,p)=>{if(H>=0){let _=H+1&4294967295;if(A!==_){let S=A-_+4294967296&4294967295;S<1e3&&(console.error("[OSCInWorker] Detected",S,"dropped messages (expected seq",_,"got",A,")"),r&&Atomics.add(r,28,S))}}H=A;let i=new Uint8Array(a);for(let _=0;_<a;_++)i[_]=F[R+_];t.push({oscData:i,sequence:A,timestamp:X()}),r&&(Atomics.add(r,26,1),Atomics.add(r,27,a))},onCorruption:R=>{console.error("[OSCInWorker] Corrupted message at position",R),r&&(Atomics.add(r,28,1),Atomics.add(r,29,1))}});return N>0&&Atomics.store(n,U.OUT_TAIL,s),t},V=()=>{for(;L;)try{let o=Atomics.load(n,U.OUT_HEAD),e=Atomics.load(n,U.OUT_TAIL);o===e&&Atomics.wait(n,U.OUT_HEAD,o);let t=k();t.length>0&&self.postMessage({type:"messages",messages:t})}catch(o){console.error("[OSCInWorker] Error in wait loop:",o),self.postMessage({type:"error",error:o.message}),Atomics.wait(n,0,n[0],10)}},Z=()=>{if(!D){console.error("[OSCInWorker] Cannot start - not initialized");return}L||(L=!0,V())},b=()=>{L=!1};self.addEventListener("message",o=>{let{data:e}=o;try{switch(e.type){case"init":K(e.sharedBuffer,e.ringBufferBase,e.bufferConstants),self.postMessage({type:"initialized"});break;case"start":Z();break;case"stop":b();break;default:}}catch(t){console.error("[OSCInWorker] Error:",t),self.postMessage({type:"error",error:t.message})}});Q("[OSCInWorker] Script loaded");})();
