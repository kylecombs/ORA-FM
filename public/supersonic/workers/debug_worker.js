(()=>{function g({uint8View:o,dataView:t,bufferStart:e,bufferSize:E,head:S,tail:C,messageMagic:I,paddingMagic:B,headerSize:R,maxMessages:p=1/0,onMessage:U,onCorruption:_}){let s=C,u=0,l=O=>{let T=O;if(T+4<=E)return t.getUint32(e+T,!0);let D=0;for(let a=0;a<4;a++)D|=o[e+(T+a)%E]<<a*8;return D};for(;s!==S&&u<p;){let O=E-s,T;if(O>=4?T=t.getUint32(e+s,!0):T=l(s),T===B){s=0;continue}if(T!==I){_&&_(s),s=(s+1)%E;continue}let D=l((s+4)%E),a=l((s+8)%E),F=l((s+12)%E);if(D<R||D>E){_&&_(s),s=(s+1)%E;continue}let d=D-R,m=e+(s+R)%E;U(m,d,a,F),s=(s+D)%E,u++}return{newTail:s,messagesRead:u}}function f(o,t){let e=o+t;return{DEBUG_HEAD:(e+16)/4,DEBUG_TAIL:(e+20)/4}}var i="sab",A=null,L=null,r=null,P=null,H=null,n=null,c={},x=null,N=!1,G=new TextDecoder("utf-8"),b=(...o)=>{},w=(o,t,e)=>{A=o,L=t,n=e,r=new Int32Array(A),P=new DataView(A),H=new Uint8Array(A),c=f(L,n.CONTROL_START);let E=L+n.METRICS_START;x=new Uint32Array(A,E,n.METRICS_SIZE/4)},W=()=>{let o=Atomics.load(r,c.DEBUG_HEAD),t=Atomics.load(r,c.DEBUG_TAIL);if(o===t)return null;let e=[],{newTail:E,messagesRead:S}=g({uint8View:H,dataView:P,bufferStart:L+n.DEBUG_BUFFER_START,bufferSize:n.DEBUG_BUFFER_SIZE,head:o,tail:t,messageMagic:n.MESSAGE_MAGIC,paddingMagic:n.PADDING_MAGIC,headerSize:n.MESSAGE_HEADER_SIZE,maxMessages:1e3,onMessage:(C,I,B,R)=>{let p=new Uint8Array(I);for(let _=0;_<I;_++)p[_]=H[C+_];let U=G.decode(p);U.endsWith(`
`)&&(U=U.slice(0,-1)),e.push({text:U,timestamp:performance.now(),sequence:B}),x&&(Atomics.add(x,30,1),Atomics.add(x,31,I))},onCorruption:C=>{console.error("[DebugWorker] Corrupted message at position",C)}});return S>0&&Atomics.store(r,c.DEBUG_TAIL,E),e.length>0?e:null},X=()=>{for(;N;)try{let o=Atomics.load(r,c.DEBUG_HEAD),t=Atomics.load(r,c.DEBUG_TAIL);o===t&&Atomics.wait(r,c.DEBUG_HEAD,o);let e=W();e&&e.length>0&&self.postMessage({type:"debug",messages:e})}catch(o){console.error("[DebugWorker] Error in wait loop:",o),self.postMessage({type:"error",error:o.message}),Atomics.wait(r,0,r[0],10)}},k=()=>{if(!A){console.error("[DebugWorker] Cannot start - not initialized");return}N||(N=!0,X())},Q=()=>{N=!1},K=()=>{A&&(Atomics.store(r,c.DEBUG_HEAD,0),Atomics.store(r,c.DEBUG_TAIL,0))},h=o=>{let t=[];for(let e of o)try{let E=new Uint8Array(e.bytes),S=G.decode(E);S.endsWith(`
`)&&(S=S.slice(0,-1)),t.push({text:S,timestamp:performance.now(),sequence:e.sequence})}catch(E){console.error("[DebugWorker] Failed to decode message:",E)}t.length>0&&self.postMessage({type:"debug",messages:t})};self.addEventListener("message",o=>{let{data:t}=o;try{switch(t.type){case"init":i=t.mode||"sab",i==="sab"&&w(t.sharedBuffer,t.ringBufferBase,t.bufferConstants),self.postMessage({type:"initialized"});break;case"start":i==="sab"&&k();break;case"stop":Q();break;case"clear":i==="sab"&&K();break;case"debugRaw":t.messages&&h(t.messages);break;default:}}catch(e){console.error("[DebugWorker] Error:",e),self.postMessage({type:"error",error:e.message})}});b("[DebugWorker] Script loaded");})();
